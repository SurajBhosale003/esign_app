var Ue=Object.defineProperty,Be=Object.defineProperties;var Te=Object.getOwnPropertyDescriptors;var oe=Object.getOwnPropertySymbols;var Ae=Object.prototype.hasOwnProperty,Oe=Object.prototype.propertyIsEnumerable;var se=(c,i,d)=>i in c?Ue(c,i,{enumerable:!0,configurable:!0,writable:!0,value:d}):c[i]=d,D=(c,i)=>{for(var d in i||(i={}))Ae.call(i,d)&&se(c,d,i[d]);if(oe)for(var d of oe(i))Oe.call(i,d)&&se(c,d,i[d]);return c},_=(c,i)=>Be(c,Te(i));var P=(c,i,d)=>new Promise((b,p)=>{var l=j=>{try{w(d.next(j))}catch(N){p(N)}},a=j=>{try{w(d.throw(j))}catch(N){p(N)}},w=j=>j.done?b(j.value):Promise.resolve(j.value).then(l,a);w((d=d.apply(c,i)).next())});import{r as u,j as t,u as We,h as Ie,M as Fe}from"./index-SDcol3JM.js";import{Q as $e,B as ne,Y as ae}from"./react-toastify.esm-Dj3YYmF6.js";import{p as Je,d as Le,H as Ve,D as qe,i as Qe,B as Ye,a as Ge,s as Ke,P as re,r as Xe}from"./PDFtoBase64-aQnwWDhC.js";import{M as Ze}from"./index-CGE8dmKi.js";function et(c){const i=new Set;return c.forEach(d=>{d.assign&&d.assign.forEach(b=>{i.add(b)})}),Array.from(i)}const tt=({pdfData:c})=>{const i=u.useRef(null);return u.useEffect(()=>{P(void 0,null,function*(){const b=i.current;if(b){const l=yield(yield Je.getDocument({data:atob(c)}).promise).getPage(1),a=l.getViewport({scale:1}),w=b.getContext("2d");if(w){w.clearRect(0,0,b.width,b.height),b.width=a.width,b.height=a.height;const j={canvasContext:w,viewport:a};yield l.render(j).promise}}else console.error("Canvas not found.")})},[c]),t.jsx("canvas",{ref:i,width:297,height:420})};function ot({owner_email:c,assigned_user:i}){const[d,b]=u.useState(!1),p=()=>{console.log(i),b(!0)};return t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"bg-[#283C42] text-white px-4 py-2 rounded border-2 border-transparent hover:border-[#283C42] hover:bg-white hover:text-[#283C42] transition-colors duration-300",onClick:p,children:"Send Document"}),t.jsxs(Ze,{title:"Send Document",open:d,onCancel:()=>b(!1),footer:null,children:[t.jsxs("p",{children:["Owner Email: ",c]}),t.jsxs("p",{children:["Assigned Users: ",i.join(" | ")]})]})]})}function dt(){var q,Q,Y,G;const c=We(),i=Ie(),[d,b]=u.useState([]),[p,l]=u.useState([]),[a,w]=u.useState(null),[j,N]=u.useState(null),[T,O]=u.useState(""),[ie,W]=u.useState(""),[y,R]=u.useState(0),[H,A]=u.useState(Le),de=u.useRef(null),S=u.useRef(null),le=u.useRef(null),{documentData:v}=i.state||{};if(!v)return console.log("Data State",v),t.jsx("p",{children:"Document not found"});u.useEffect(()=>{P(this,null,function*(){try{const s=yield(yield fetch(`/api/method/esign_app.api.get_document_components_and_basepdf?document_name=${v?v.name:""}`)).json();if(console.log("documentData :",JSON.stringify(v)),console.log(s),s.message.document_json_data==null||s.message.base_pdf_datad==null)return;if(s.message.status===200){const n=typeof s.message.document_json_data=="string"?JSON.parse(s.message.document_json_data):s.message.document_json_data,r=typeof s.message.base_pdf_datad=="string"?JSON.parse(s.message.base_pdf_datad):s.message.base_pdf_datad;console.log("Parseeee",n),console.log("Baseeee",r),l(n),A(r)}}catch(o){console.error("Error:",o)}}),I()},[]);const I=()=>{const e=et(p);b(e)};u.useEffect(()=>{I()},[p]);const ce={name:"editable",props:[],events:[],render(e,o){const s=e.getRect(),{pos2:n}=e.state,r=e.useCSS("div",`
        {
            position: absolute;
            left: 0px;
            top: 0px;
            will-change: transform;
            transform-origin: 0px 0px;
        }
        .custom-button {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            background: #283C42;
            border-radius: 4px;
            appearance: none;
            border: 0;
            color: white;
            font-weight: bold;
        }
            `);return t.jsxs(r,{className:"moveable-editable",style:{transform:`translate(${n[0]}px, ${n[1]}px) rotate(${s.rotation}deg) translate(10px)`},children:[t.jsx("button",{className:"w-6 h-6 mb-1 p-1 bg-[#283C42] rounded border-none text-white font-bold",onClick:L,children:t.jsx("svg",{viewBox:"0 0 1024 1024",fill:"currentColor",height:"1em",width:"1em",children:t.jsx("path",{d:"M360 184h-8c4.4 0 8-3.6 8-8v8h304v-8c0 4.4 3.6 8 8 8h-8v72h72v-80c0-35.3-28.7-64-64-64H352c-35.3 0-64 28.7-64 64v80h72v-72zm504 72H160c-17.7 0-32 14.3-32 32v32c0 4.4 3.6 8 8 8h60.4l24.7 523c1.6 34.1 29.8 61 63.9 61h454c34.2 0 62.3-26.8 63.9-61l24.7-523H888c4.4 0 8-3.6 8-8v-32c0-17.7-14.3-32-32-32zM731.3 840H292.7l-24.2-512h487l-24.2 512z"})})}),t.jsx("button",{className:"w-6 h-6 mb-1 p-1 bg-[#283C42] rounded border-none text-white font-bold",onClick:()=>{a!==null&&Se(a)},children:t.jsxs("svg",{viewBox:"0 0 1024 1024",fill:"currentColor",height:"1em",width:"1em",children:[t.jsx("defs",{children:t.jsx("style",{})}),t.jsx("path",{d:"M899.1 869.6l-53-305.6H864c14.4 0 26-11.6 26-26V346c0-14.4-11.6-26-26-26H618V138c0-14.4-11.6-26-26-26H432c-14.4 0-26 11.6-26 26v182H160c-14.4 0-26 11.6-26 26v192c0 14.4 11.6 26 26 26h17.9l-53 305.6c-.3 1.5-.4 3-.4 4.4 0 14.4 11.6 26 26 26h723c1.5 0 3-.1 4.4-.4 14.2-2.4 23.7-15.9 21.2-30zM204 390h272V182h72v208h272v104H204V390zm468 440V674c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v156H416V674c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v156H202.8l45.1-260H776l45.1 260H672z"})]})})]},"editable-viewer")}},he=()=>{y<H.length-1&&(R(y+1),N(null),w(null))},ge=()=>{y>0&&(R(y-1),N(null),w(null))},pe=e=>{O(e.target.value)},ue=()=>{a!==null&&T.trim()!==""&&(l(e=>e.map(o=>o.id===a?_(D({},o),{assign:[...o.assign||[],T]}):o)),O(""))},xe=e=>{a!==null&&l(o=>o.map(s=>s.id===a?_(D({},s),{assign:(s.assign||[]).filter(n=>n!==e)}):s))},F=e=>{const o={id:Date.now(),type:e,pageNo:y,name:`${e}-${Date.now()}`,position:{top:50,left:50},size:{width:100,height:100},fontSize:16,value:"",assign:[],content:e==="text"?"":void 0};l([...p,o])},me=(e,o,s)=>{l(n=>n.map(r=>r.id===e?_(D({},r),{position:{top:o,left:s}}):r))},$=(e,o,s)=>{l(n=>n.map(r=>r.id===e?_(D({},r),{size:{width:o,height:s}}):r))},be=e=>{const o=e.target.value;W(o),a!==null&&l(s=>s.map(n=>n.id===a?_(D({},n),{content:o,value:o}):n))},fe=e=>{e.target.closest(".component")||(w(null),N(null))},J=e=>{a!==null&&l(o=>o.map(s=>s.id===a?_(D({},s),{fontSize:(s.fontSize||16)+(e?2:-2)}):s))},L=()=>{a!==null&&(l(e=>e.filter(o=>o.id!==a)),w(null),N(null))},ve=()=>{console.log("Assigned Unique list: ",d)},we=()=>{const e=p.map(({id:o,type:s,content:n,pageNo:r,value:x,position:m,size:h,name:k,fontSize:g,assign:C})=>({id:o,type:s,content:n,pageNo:r,value:x,position:m,size:h,name:k,fontSize:g,assign:C}));console.log(JSON.stringify(e,null,2))},Ce=e=>{switch(e.target.value){case"loadComponents":l(Qe);break;case"loadDexcissComponents":l(qe);break;case"loadHelloDexcissComponents":l(Ve);break;case"loadBlank":l([]);break;default:l([])}},je=()=>P(this,null,function*(){try{R(0),l([]),A(Ye)}catch(e){console.error("Error loading data:",e)}}),ye=e=>P(this,null,function*(){var s;const o=(s=e.target.files)==null?void 0:s[0];if(o){const n=yield Ge(o),r=yield Ke(n);A(r),R(0)}});u.useEffect(()=>{if(a!==null){const e=document.querySelector(`[data-id="${a}"]`);N(e);const o=p.find(s=>s.id===a);(o==null?void 0:o.type)==="text"&&W(o.content||"")}},[a,p]);const V=e=>Uint8Array.from(atob(e),o=>o.charCodeAt(0)),Ne=()=>P(this,null,function*(){var k;const e=yield re.create();for(let g=0;g<H.length;g++){const C=V(H[g].data),z=yield re.load(C);(yield e.copyPages(z,z.getPageIndices())).forEach(E=>e.addPage(E))}const o=p.reduce((g,C)=>(g[C.pageNo]||(g[C.pageNo]=[]),g[C.pageNo].push(C),g),{}),s=e.getPages();for(const g of s){const C=s.indexOf(g),z=o[C]||[];for(const f of z){const{left:E,top:K}=f.position;if(f.type==="text"){const M=(k=f.fontSize)!=null?k:12,U=g.getHeight()-K-M-3;g.drawText(f.content||"",{x:E+3,y:U,size:f.fontSize,color:Xe(0,0,0),lineHeight:M*1.2,maxWidth:f.size.width})}else if(f.type==="image"&&f.content){const M=f.content.split(",")[1];if(!M){console.error("Invalid image data");continue}const U=V(M);let B;if(f.content.startsWith("data:image/png"))B=yield e.embedPng(U);else if(f.content.startsWith("data:image/jpeg")||f.content.startsWith("data:image/jpg"))B=yield e.embedJpg(U);else{console.error("Unsupported image format");continue}const{width:X,height:Z}=B,_e=f.size.width,He=f.size.height,Pe=_e/X,ze=He/Z,ee=Math.min(Pe,ze),Me=X*ee,te=Z*ee,Re=E,Ee=g.getHeight()-K-te;g.drawImage(B,{x:Re,y:Ee,width:Me,height:te})}}}const n=yield e.save(),r=new Blob([n],{type:"application/pdf"}),x=URL.createObjectURL(r),m=`esignDoc-${v.document_title}`,h=document.createElement("a");h.href=x,h.download=`${m}.pdf`,document.body.appendChild(h),h.click(),document.body.removeChild(h),URL.revokeObjectURL(x)}),Se=e=>{l(o=>o.map(s=>s.id===e?_(D({},s),{content:void 0,value:void 0}):s))},ke=(e,o)=>{var n;const s=(n=e.target.files)==null?void 0:n[0];if(s){const r=new FileReader;r.onloadend=()=>{const x=r.result;l(m=>m.map(h=>h.id===o?_(D({},h),{content:x}):h))},r.readAsDataURL(s)}},De=()=>P(this,null,function*(){if(!v||!v.document_title)return;const e=p.map(({id:s,type:n,content:r,pageNo:x,value:m,position:h,size:k,name:g,fontSize:C,assign:z})=>({id:s,type:n,pageNo:x,assign:z,size:k,name:g,fontSize:C,position:h,content:r,value:m}));console.log(JSON.stringify(e,null,2));const o={document_title:v.name,document_json_data:JSON.stringify(JSON.stringify(e,null,2)),base_pdf_datad:JSON.stringify(JSON.stringify(H,null,2)),assigned_user_list:JSON.stringify(JSON.stringify(d,null,2))};try{const n=yield(yield fetch("/api/method/esign_app.api.update_document",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).json();console.log(n),n.message.status<300?ne.success("Document Updated Successfully",{position:"top-right",autoClose:500,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"dark",transition:ae}):ne.error("Error while updating template",{position:"top-right",autoClose:500,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0,progress:void 0,theme:"dark",transition:ae})}catch(s){console.error("Error:",s),alert("An error occurred while updating the template")}});return t.jsx(t.Fragment,{children:t.jsxs("div",{children:[t.jsxs("div",{className:"relative p-2 bg-[#283C42] text-white border-2 border-transparent hover:border-[#283C42] transition-colors duration-300",children:[t.jsx("button",{className:"absolute top-2 right-2 bg-[#551116] text-white px-5 py-1 rounded border-2 border-transparent hover:border-[#551116] hover:bg-white hover:text-[#551116] transition-colors duration-300",onClick:()=>c(-1),children:"Back"}),t.jsx("h1",{className:"text-lg font-bold",children:v.document_title}),t.jsx("p",{className:"text-sm",children:v.template_title}),t.jsxs("p",{className:"text-sm",children:["Email: ",v.owner_email]}),t.jsxs("p",{className:"text-sm",children:["Created At: ",v.document_created_at]})]}),t.jsxs("div",{className:"document-main-drag-class",children:[t.jsxs("div",{className:"templete-main-div",children:[t.jsxs("div",{className:"control-buttons gap-2 text-xs",children:[t.jsx("input",{type:"file",accept:"application/pdf",onChange:ye,className:"bg-gray-100 text-[#283C42] border-1 border-[#283C42] px-4 py-2 rounded hover:bg-[#283C42] hover:text-white hover:border-white transition-colors duration-300"}),t.jsxs("select",{className:"bg-[#283C42] text-white px-4 py-2 rounded border-2 border-transparent hover:border-[#283C42] hover:bg-white hover:text-[#283C42] transition-colors duration-300",onChange:Ce,children:[t.jsx("option",{value:"",disabled:!0,selected:!0,children:"Select Template"}),t.jsx("option",{value:"loadBlank",children:"Blank"}),t.jsx("option",{value:"loadComponents",children:"Load Template 1"}),t.jsx("option",{value:"loadDexcissComponents",children:"Load Dexciss Components"}),t.jsx("option",{value:"loadHelloDexcissComponents",children:"Load Hello Dexciss Components"})]}),t.jsx("button",{className:"bg-[#283C42] text-white px-4 py-2 rounded border-2 border-transparent hover:border-[#283C42] hover:bg-white hover:text-[#283C42] transition-colors duration-300",onClick:je,children:"Load Blank Page"}),t.jsx("button",{className:"bg-[#283C42] text-white px-4 py-2 rounded border-2 border-transparent hover:border-[#283C42] hover:bg-white hover:text-[#283C42] transition-colors duration-300",onClick:()=>F("text"),children:"Add Text"}),t.jsx("button",{className:"bg-[#283C42] text-white px-4 py-2 rounded border-2 border-transparent hover:border-[#283C42] hover:bg-white hover:text-[#283C42] transition-colors duration-300",onClick:()=>F("image"),children:"Add Image"}),t.jsx("button",{className:"bg-[#283C42] text-white px-4 py-2 rounded border-2 border-transparent hover:border-[#283C42] hover:bg-white hover:text-[#283C42] transition-colors duration-300",onClick:we,children:"Log Component Data"}),t.jsx("button",{className:"bg-[#283C42] text-white px-4 py-2 rounded border-2 border-transparent hover:border-[#283C42] hover:bg-white hover:text-[#283C42] transition-colors duration-300",onClick:ve,children:"Log Assign User Data"}),t.jsx("button",{className:"bg-[#283C42] text-white px-4 py-2 rounded border-2 border-transparent hover:border-[#283C42] hover:bg-white hover:text-[#283C42] transition-colors duration-300",onClick:Ne,children:"Merge and Print PDF"}),t.jsx("button",{className:"bg-[#283C42] text-white px-4 py-2 rounded border-2 border-transparent hover:border-[#283C42] hover:bg-white hover:text-[#283C42] transition-colors duration-300",onClick:De,children:"Save Document"}),t.jsx(ot,{owner_email:v.owner_email,assigned_user:d})]}),t.jsxs("div",{className:"templete-app text-xs",children:[t.jsxs("div",{className:"flex gap-3 mb-2",children:[t.jsx("button",{className:"bg-[#283C42] text-white px-4 py-2 rounded border-2 border-transparent hover:border-[#283C42] hover:bg-white hover:text-[#283C42] transition-colors duration-300",onClick:ge,disabled:y===0,children:"Previous"}),t.jsxs("h1",{className:"mt-2",children:[y+1," / ",H.length]}),t.jsx("button",{className:"bg-[#283C42] text-white px-4 py-2 rounded border-2 border-transparent hover:border-[#283C42] hover:bg-white hover:text-[#283C42] transition-colors duration-300",onClick:he,disabled:y===H.length-1,children:"Next"})]}),t.jsxs("div",{className:"workspace",ref:S,onClick:fe,children:[t.jsx(tt,{pdfData:H[y].data}),p.filter(e=>e.pageNo===y).map(e=>t.jsx("div",{"data-id":e.id,className:`component ${e.type} ${a===e.id?"selected":""}`,style:{position:"absolute",top:e.position.top,left:e.position.left,width:e.size.width,height:e.size.height,border:a===e.id?"1px solid red":"none",fontSize:`${e.fontSize}px`,userSelect:"none",overflow:"hidden"},onClick:o=>{o.stopPropagation(),w(e.id)},children:e.type==="text"?t.jsx("div",{style:{width:"100%",height:"100%",overflow:"hidden",fontSize:"inherit",outline:"none"},children:e.content||"Editable Text"}):t.jsxs("div",{style:{position:"relative",width:"100%",height:"100%"},children:[!e.content&&t.jsx("input",{type:"file",accept:"image/*",onChange:o=>ke(o,e.id)}),e.content&&t.jsx("div",{children:t.jsx("img",{src:e.content,alt:"Uploaded",style:{width:"100%",height:"100%"}})})]})},e.id)),t.jsx(Fe,{ref:de,target:j,resizable:!0,draggable:!0,ables:[ce],props:{editable:!0},bounds:{left:0,top:0,right:((q=S.current)==null?void 0:q.offsetWidth)||0,bottom:((Q=S.current)==null?void 0:Q.offsetHeight)||0},onDrag:e=>{var h,k;const o=((h=S.current)==null?void 0:h.offsetWidth)||0,s=((k=S.current)==null?void 0:k.offsetHeight)||0,n=e.target.clientWidth||0,r=e.target.clientHeight||0,x=Math.max(0,Math.min(e.top,s-r)),m=Math.max(0,Math.min(e.left,o-n));a!==null&&me(a,x,m)},onResize:e=>{var x,m;const o=((x=S.current)==null?void 0:x.offsetWidth)||0,s=((m=S.current)==null?void 0:m.offsetHeight)||0,n=Math.max(0,Math.min(e.width,o)),r=Math.max(0,Math.min(e.height,s));e.target.style.width=`${n}px`,e.target.style.height=`${r}px`,a!==null&&$(a,n,r)},onScale:e=>{var r,x;const o=((r=S.current)==null?void 0:r.offsetWidth)||0,s=((x=S.current)==null?void 0:x.offsetHeight)||0,n=p.find(m=>m.id===a);if(n){const m=Math.max(0,Math.min(n.size.width*e.scale[0],o)),h=Math.max(0,Math.min(n.size.height*e.scale[1],s));$(a,m,h)}}})]})]}),t.jsxs("div",{className:"right-templete",children:[t.jsx("div",{className:"templete-utility-btn mt-2 text-xs pr-20",children:a&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"bg-[#283C42] text-white px-4 py-2 rounded border-2 border-transparent hover:border-[#283C42] hover:bg-white hover:text-[#283C42] transition-colors duration-300",onClick:()=>J(!0),children:"Increase Text Size"}),t.jsx("button",{className:"bg-[#283C42] text-white px-4 py-2 rounded border-2 border-transparent hover:border-[#283C42] hover:bg-white hover:text-[#283C42] transition-colors duration-300",onClick:()=>J(!1),children:"Decrease Text Size"}),t.jsx("button",{className:"bg-[#283C42] text-white px-4 py-2 rounded border-2 border-transparent hover:border-[#283C42] hover:bg-white hover:text-[#283C42] transition-colors duration-300",onClick:L,children:"Delete Component"}),t.jsx("input",{className:"bg-[#d1e0e4] text-gray-700 focus:outline-none focus:shadow-outline border border-gray-300 rounded py-2 px-4 block w-full appearance-none",ref:le,type:"text",value:ie,onChange:be,placeholder:"Edit text here"})]})}),a&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"templete-utility-btn-add-user flex m-3 gap-3 text-xs pr-10 ml-0",children:[t.jsx("input",{className:"mt-3 bg-[#d1e0e4]  text-gray-700 focus:outline-none focus:shadow-outline border border-gray-300 rounded py-2 px-4 block w-full appearance-none",type:"text",value:T,onChange:pe,placeholder:"Add user"}),t.jsx("button",{className:"mt-3  bg-[#283C42] text-white px-4 py-2 rounded border-2 border-transparent hover:border-[#283C42] hover:bg-white hover:text-[#283C42] transition-colors duration-300",onClick:ue,children:"Add"})]}),t.jsx("div",{children:t.jsx("ul",{className:"list-none p-0 m-0 pr-10",children:(G=(Y=p.find(e=>e.id===a))==null?void 0:Y.assign)==null?void 0:G.map((e,o)=>t.jsxs("li",{className:"mr-3 flex items-center justify-between p-2 border-b border-gray-200 hover:bg-gray-100",children:[t.jsx("span",{className:"text-xs text-gray-800 overflow-hidden ",children:e}),t.jsx("button",{onClick:()=>xe(e),className:"flex items-center justify-center w-8 h-8 bg-red-500 text-white rounded-full hover:bg-red-600","aria-label":"Remove user",children:t.jsx("svg",{viewBox:"0 0 1024 1024",fill:"currentColor",height:"1em",width:"1em",children:t.jsx("path",{d:"M678.3 655.4c24.2-13 51.9-20.4 81.4-20.4h.1c3 0 4.4-3.6 2.2-5.6a371.67 371.67 0 00-103.7-65.8c-.4-.2-.8-.3-1.2-.5C719.2 518 759.6 444.7 759.6 362c0-137-110.8-248-247.5-248S264.7 225 264.7 362c0 82.7 40.4 156 102.6 201.1-.4.2-.8.3-1.2.5-44.7 18.9-84.8 46-119.3 80.6a373.42 373.42 0 00-80.4 119.5A373.6 373.6 0 00137 901.8a8 8 0 008 8.2h59.9c4.3 0 7.9-3.5 8-7.8 2-77.2 32.9-149.5 87.6-204.3C357 641.2 432.2 610 512.2 610c56.7 0 111.1 15.7 158 45.1a8.1 8.1 0 008.1.3zM512.2 534c-45.8 0-88.9-17.9-121.4-50.4A171.2 171.2 0 01340.5 362c0-45.9 17.9-89.1 50.3-121.6S466.3 190 512.2 190s88.9 17.9 121.4 50.4A171.2 171.2 0 01683.9 362c0 45.9-17.9 89.1-50.3 121.6C601.1 516.1 558 534 512.2 534zM880 772H640c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h240c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"})})})]},o))})})]})]})]}),t.jsx($e,{limit:1})]})]})})}export{dt as default};
